<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ›œç‚å‰µæ„å¨›æ¨‚</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
      color: #111827;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 24px;
    }
    .subtitle {
      color: #6b7280;
      margin-bottom: 16px;
      font-size: 14px;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .user-info {
      font-size: 12px;
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .role-pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e0f2fe;
      color: #0369a1;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 380px) minmax(0, 1fr);
      gap: 16px;
    }
    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 15px -10px rgba(0, 0, 0, 0.15);
    }
    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }
    .section-title {
      font-size: 12px;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 12px 0 4px;
      border-top: 1px dashed #e5e7eb;
      padding-top: 10px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
    }
    .form-grid-full {
      grid-column: 1 / -1;
    }
    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #4b5563;
    }
    input, select, textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      background: #f9fafb;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb22;
      background: #ffffff;
    }
    input[disabled], select[disabled], textarea[disabled] {
      background: #f3f4f6;
      color: #9ca3af;
    }
    .actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      background: #2563eb;
      color: #ffffff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }
    .btn-danger {
      background: #ef4444;
      color: #ffffff;
    }
    .btn-small {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      flex-wrap: wrap;
    }
    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eef2ff;
      color: #4338ca;
      white-space: nowrap;
    }
    .status-pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      white-space: nowrap;
    }
    .status-booked {
      background: #e0f2fe;
      color: #0369a1;
    }
    .status-progress {
      background: #fef3c7;
      color: #92400e;
    }
    .status-done {
      background: #dcfce7;
      color: #166534;
    }
    .status-cancel {
      background: #fee2e2;
      color: #b91c1c;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    thead {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }
    th {
      text-align: left;
      font-weight: 600;
      color: #4b5563;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    .row-selected {
      background: #e0f2fe !important;
    }
    .table-wrapper {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }
    .table-wrapper + .table-wrapper {
      margin-top: 8px;
    }
    .text-right {
      text-align: right;
    }
    .muted {
      color: #9ca3af;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    .summary-item {
      padding: 8px;
      border-radius: 10px;
      background: #f9fafb;
      font-size: 11px;
    }
    .summary-label {
      color: #6b7280;
      margin-bottom: 4px;
    }
    .summary-value {
      font-size: 14px;
      font-weight: 600;
    }
    .summary-hint {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .no-data {
      text-align: center;
      padding: 16px;
      font-size: 13px;
      color: #9ca3af;
    }
    .details-card {
      margin-top: 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 12px;
      background: #f9fafb;
      font-size: 12px;
    }
    .details-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }
    .details-title {
      font-weight: 600;
    }
    .details-subtitle {
      font-size: 11px;
      color: #6b7280;
    }
    .details-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px 12px;
      margin-top: 8px;
    }
    .details-section-title {
      font-size: 11px;
      font-weight: 600;
      color: #4b5563;
      margin-top: 4px;
      margin-bottom: 2px;
    }
    .details-item-label {
      font-size: 11px;
      color: #6b7280;
    }
    .details-item-value {
      font-size: 12px;
      font-weight: 500;
    }
    @media (max-width: 960px) {
      .summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .details-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 640px) {
      .details-grid {
        grid-template-columns: 1fr;
      }
    }
    .view-tabs {
      display: inline-flex;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 2px;
      margin-bottom: 8px;
      gap: 2px;
    }
    .tab-button {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 12px;
      background: transparent;
      cursor: pointer;
      color: #4b5563;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .tab-button-active {
      background: #111827;
      color: #f9fafb;
    }
    /* è¨­å‚™ 10 è¡Œï¼šæ’ç‰ˆ */
    .equipment-line-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 12px;
    }
    .equipment-line-row span {
      width: 46px;
      color: #6b7280;
    }
    .equipment-line-row select {
      flex: 1;
    }
    .equipment-line-row input {
      width: 80px;
    }
    /* è¡Œäº‹æ›† */
    .calendar-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 4px;
    }
    .calendar-table th,
    .calendar-table td {
      border: 1px solid #e5e7eb;
      padding: 4px;
      vertical-align: top;
      height: 72px;
    }
    .calendar-table th {
      background: #f3f4f6;
      text-align: center;
      font-weight: 600;
      color: #4b5563;
    }
    .calendar-day-number {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .calendar-day-usage {
      font-size: 11px;
      color: #4b5563;
    }
    .calendar-ok {
      background: #ecfdf5;
    }
    .calendar-over {
      background: #fee2e2;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <h1>æ›œç‚å‰µæ„å¨›æ¨‚</h1>
      <div class="subtitle">
        å¤šäººå…±ç”¨ã€å³æ™‚åŒæ­¥ã€‚ä¾æœˆä»½æŸ¥çœ‹æ”¶æ”¯ã€äººåŠ›æ’ç­ã€è¨­å‚™å‡ºå‹¤èˆ‡è¨­å‚™åº«å­˜ã€‚
      </div>
    </div>
    <div class="user-info">
      <span id="user-info-text">å°šæœªç™»å…¥</span>
      <span id="user-role-pill" class="role-pill" style="display:none;"></span>
      <button class="btn-secondary btn-small" id="login-btn">ä½¿ç”¨ Google ç™»å…¥</button>
      <button class="btn-secondary btn-small" id="logout-btn" style="display:none;">ç™»å‡º</button>
    </div>
  </div>

  <div class="layout">
    <!-- å·¦å´ï¼šè¡¨å–® -->
    <div class="card">
      <h2 id="form-title">æ–°å¢å°ˆæ¡ˆ Project</h2>
      <div id="form-permission-hint" class="muted" style="font-size:12px;margin-bottom:6px;">
        ğŸ”’ è«‹å…ˆç™»å…¥ï¼Œä¸”æ¬Šé™ç‚º staff / manager / admin æ‰èƒ½æ–°å¢æˆ–ç·¨è¼¯å°ˆæ¡ˆã€‚
      </div>
      <form id="project-form">
        <div class="form-grid">
          <!-- åŸºæœ¬è³‡è¨Š -->
          <div class="form-grid-full section-title">åŸºæœ¬è³‡è¨Š</div>
          <div class="form-grid-full">
            <label>å°ˆæ¡ˆåç¨± Project Name</label>
            <input type="text" id="project-name" required placeholder="ä¾‹å¦‚ï¼šMV æ‹æ”ï¼å“ç‰Œ X" />
          </div>
          <div>
            <label>å®¢æˆ¶ Client</label>
            <input type="text" id="client" placeholder="ä¾‹å¦‚ï¼šå“ç‰Œï¼è£½ä½œå…¬å¸åç¨±" />
          </div>
          <div>
            <label>æª”æœŸé–‹å§‹ Start Date</label>
            <input type="date" id="start-date" required />
          </div>
          <div>
            <label>æª”æœŸçµæŸ End Date</label>
            <input type="date" id="end-date" />
          </div>

          <!-- è¨­å‚™ï¼š10 è¡Œ from è¨­å‚™æ¸…å–® -->
          <div class="form-grid-full section-title">è¨­å‚™ Equipment</div>
          <div class="form-grid-full">
            <label>ä½¿ç”¨è¨­å‚™ï¼ˆæœ€å¤š 10 ç­†ï¼‰</label>
            <div id="equipment-lines"></div>
            <div class="muted" style="font-size:11px; margin-top:4px;">
              è¨­å‚™åç¨±å¾ã€Œè¨­å‚™æ¸…å–®ã€ä¸‹æ‹‰é¸æ“‡ï¼Œæ•¸é‡ä»£è¡¨æœ¬å°ˆæ¡ˆåœ¨æª”æœŸå…§éœ€è¦çš„å°æ•¸ã€‚<br />
              ï¼ˆä¹‹å¾Œæœƒç”¨ä¾†ç®—è¡Œäº‹æ›†æ˜¯å¦è¶…å‡ºç¸½è¨­å‚™æ•¸ï¼‰
            </div>
          </div>
          <div>
            <label>è¨­å‚™ä¾†æº Source</label>
            <select id="equipment-source">
              <option value="own">è‡ªæœ‰è¨­å‚™</option>
              <option value="rental">ç§Ÿå€Ÿ</option>
              <option value="mixed">è‡ªæœ‰ï¼‹ç§Ÿå€Ÿ</option>
            </select>
          </div>
          <div>
            <label>è‡ªæœ‰è¨­å‚™æˆæœ¬ Own Cost (NTD)</label>
            <input type="number" id="equipment-own-cost" min="0" step="100" />
          </div>
          <div>
            <label>ç§Ÿå€Ÿè¨­å‚™æˆæœ¬ Rental Cost (NTD)</label>
            <input type="number" id="equipment-rental-cost" min="0" step="100" />
          </div>

          <!-- äººåŠ› -->
          <div class="form-grid-full section-title">äººåŠ› Manpower</div>
          <div>
            <label>ç¾å ´æŠ€å¸« Technician (NTD)</label>
            <input type="number" id="man-tech" min="0" step="100" />
          </div>
          <div>
            <label>åŠ©ç† Assistant (NTD)</label>
            <input type="number" id="man-assistant" min="0" step="100" />
          </div>
          <div>
            <label>å¸æ©Ÿ Driver (NTD)</label>
            <input type="number" id="man-driver" min="0" step="100" />
          </div>
          <div>
            <label>å¤œç­è²» Night Shift (NTD)</label>
            <input type="number" id="man-night" min="0" step="100" />
          </div>
          <div>
            <label>åŠ ç­è²» Overtime (NTD)</label>
            <input type="number" id="man-overtime" min="0" step="100" />
          </div>

          <!-- è²¡å‹™ -->
          <div class="form-grid-full section-title">è²¡å‹™ Financial</div>
          <div>
            <label>å ±åƒ¹é‡‘é¡ Quote (NTD)</label>
            <input type="number" id="quote-amount" min="0" step="100" />
          </div>
          <div>
            <label>å¯¦éš›åŸ·è¡Œé ç®— Project Budget (NTD)</label>
            <input type="number" id="budget" min="0" step="100" />
          </div>
          <div>
            <label>å…¶ä»–æ”¯å‡º Other Expenses (NTD)</label>
            <input type="number" id="expenses" min="0" step="100" />
          </div>
          <div>
            <label>ç¨…åˆ¥ Tax Type</label>
            <select id="tax-type">
              <option value="na">ä¸é©ç”¨ / ä¸è¨ˆ</option>
              <option value="included">å«ç¨…é‡‘é¡ (å« 5% VAT)</option>
              <option value="excluded">æœªç¨…é‡‘é¡ (5% å¦è¨ˆ)</option>
            </select>
          </div>

          <!-- è«‹æ¬¾ -->
          <div class="form-grid-full section-title">è«‹æ¬¾ & ç™¼ç¥¨ Billing</div>
          <div>
            <label>ç™¼ç¥¨è™Ÿç¢¼ Invoice No.</label>
            <input type="text" id="invoice-number" />
          </div>
          <div>
            <label>é–‹ç«‹æ—¥æœŸ Invoice Date</label>
            <input type="date" id="invoice-date" />
          </div>
          <div>
            <label>é è¨ˆæ”¶æ¬¾æ—¥ Expected Payment</label>
            <input type="date" id="expected-payment-date" />
          </div>
          <div>
            <label>å¯¦éš›æ”¶æ¬¾æ—¥ Actual Payment</label>
            <input type="date" id="actual-payment-date" />
          </div>
          <div>
            <label>è«‹æ¬¾ç‹€æ…‹ Billing Status</label>
            <select id="billing-status">
              <option value="none">å°šæœªé–‹ç«‹</option>
              <option value="invoiced">å·²é–‹ç«‹ç™¼ç¥¨</option>
              <option value="partial">éƒ¨åˆ†æ”¶æ¬¾</option>
              <option value="paid">å·²å…¨é¡æ”¶æ¬¾</option>
            </select>
          </div>

          <!-- å°ˆæ¡ˆç‹€æ…‹ & å‚™è¨» -->
          <div>
            <label>å°ˆæ¡ˆç‹€æ…‹ Project Status</label>
            <select id="project-status">
              <option value="booked">å·²ç¢ºèªæª”æœŸ</option>
              <option value="in-progress">åŸ·è¡Œä¸­</option>
              <option value="done">å·²å®Œæˆ</option>
              <option value="cancel">å–æ¶ˆ</option>
            </select>
          </div>
          <div class="form-grid-full">
            <label>å‚™è¨» Notes</label>
            <textarea id="notes" placeholder="ä¾‹å¦‚ï¼šéœ€è¦å¤œé–“åŠ ç­ï¼æˆ¶å¤–å ´éœ€å‚™é˜²æ°´è¨­å‚™â€¦â€¦"></textarea>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn-secondary" id="reset-btn">æ¸…é™¤è¡¨å–® Reset</button>
          <button type="submit" class="btn-primary" id="submit-btn">æ–°å¢å°ˆæ¡ˆ Add</button>
        </div>
      </form>
    </div>

    <!-- å³å´ï¼šåˆ—è¡¨ + è©³æƒ… + æœˆä»½ç¸½è¦½ + äººåŠ› & è¨­å‚™è¦–è§’ + è¨­å‚™æ¸…å–® + è¡Œäº‹æ›† -->
    <div>
      <div class="card">
        <div class="toolbar">
          <div class="toolbar-group">
            <span>ğŸ“… æª¢è¦–æœˆä»½ï¼š</span>
            <input type="month" id="month-filter" />
          </div>
          <div class="toolbar-group">
            <span class="pill" id="project-count-pill">å…± 0 ç­†å°ˆæ¡ˆ</span>
          </div>
          <div class="toolbar-group">
            <div class="view-tabs">
              <button class="tab-button tab-button-active" id="tab-project">å°ˆæ¡ˆç¸½è¦½</button>
              <button class="tab-button" id="tab-resource">äººåŠ› / è¨­å‚™è¦–è§’</button>
              <button class="tab-button" id="tab-equipment">è¨­å‚™æ¸…å–®</button>
            </div>
          </div>
        </div>

        <!-- View 1ï¼šå°ˆæ¡ˆç¸½è¦½ -->
        <div id="view-project">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>å°ˆæ¡ˆ / å®¢æˆ¶</th>
                  <th>æª”æœŸ</th>
                  <th class="text-right">æ·¨ç‡Ÿæ”¶</th>
                  <th class="text-right">é ä¼°æ¯›åˆ©</th>
                  <th>ç‹€æ…‹</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="project-tbody">
                <tr>
                  <td colspan="6" class="no-data">ç›®å‰å°šç„¡å°ˆæ¡ˆï¼Œè«‹å¾å·¦å´æ–°å¢ã€‚</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- ç•¶æœˆçµ±è¨ˆ -->
          <div class="summary-grid" id="summary-grid">
            <div class="summary-item">
              <div class="summary-label">ç•¶æœˆå ±åƒ¹ç¸½é¡</div>
              <div class="summary-value" id="sum-quote">NT$ 0</div>
              <div class="summary-hint">Quote é‡‘é¡åŠ ç¸½</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">ç•¶æœˆåŸ·è¡Œé ç®—</div>
              <div class="summary-value" id="sum-budget">NT$ 0</div>
              <div class="summary-hint">Project Budget åŠ ç¸½</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">ç•¶æœˆç¸½æˆæœ¬</div>
              <div class="summary-value" id="sum-cost">NT$ 0</div>
              <div class="summary-hint">è¨­å‚™ï¼‹äººåŠ›ï¼‹å…¶ä»–æ”¯å‡º</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">ç•¶æœˆæ·¨ç‡Ÿæ”¶</div>
              <div class="summary-value" id="sum-net-revenue">NT$ 0</div>
              <div class="summary-hint">æ‰£é™¤ç¨…é¡å¾Œç‡Ÿæ”¶</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">ç•¶æœˆé ä¼°æ¯›åˆ©</div>
              <div class="summary-value" id="sum-profit">NT$ 0</div>
              <div class="summary-hint">æ·¨ç‡Ÿæ”¶ âˆ’ ç¸½æˆæœ¬</div>
            </div>
          </div>

          <!-- è©³æƒ… -->
          <div class="details-card" id="details-card">
            <div class="no-data">é»é¸ä¸Šæ–¹ä»»ä¸€å°ˆæ¡ˆï¼Œå³å¯æŸ¥çœ‹è©³ç´°æˆæœ¬èˆ‡è«‹æ¬¾è³‡è¨Šã€‚</div>
          </div>
        </div>

        <!-- View 2ï¼šäººåŠ› / è¨­å‚™è¦–è§’ -->
        <div id="view-resource" style="display:none; margin-top:4px;">
          <!-- äººåŠ› & è¨­å‚™ Summary -->
          <div class="summary-grid" id="resource-summary-grid">
            <div class="summary-item">
              <div class="summary-label">æŠ€å¸«æˆæœ¬</div>
              <div class="summary-value" id="sum-man-tech">NT$ 0</div>
              <div class="summary-hint">Technician åˆè¨ˆ</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">åŠ©ç†æˆæœ¬</div>
              <div class="summary-value" id="sum-man-assistant">NT$ 0</div>
              <div class="summary-hint">Assistant åˆè¨ˆ</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">å¸æ©Ÿæˆæœ¬</div>
              <div class="summary-value" id="sum-man-driver">NT$ 0</div>
              <div class="summary-hint">Driver åˆè¨ˆ</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">å¤œç­ + åŠ ç­è²»</div>
              <div class="summary-value" id="sum-man-extra">NT$ 0</div>
              <div class="summary-hint">Night Shift + OT</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">è¨­å‚™æˆæœ¬</div>
              <div class="summary-value" id="sum-equipment">NT$ 0</div>
              <div class="summary-hint">è‡ªæœ‰ï¼‹ç§Ÿå€Ÿæˆæœ¬</div>
            </div>
          </div>

          <!-- äººåŠ›æ’ç­è¡¨ -->
          <div style="margin-top:10px; font-size:12px; font-weight:600; color:#4b5563;">
            ğŸ‘¥ äººåŠ›æ’ç­ä¸€è¦½ï¼ˆä¾æ—¥æœŸï¼‰
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th class="text-right">å°ˆæ¡ˆæ•¸</th>
                  <th class="text-right">æŠ€å¸«æ¡ˆæ•¸</th>
                  <th class="text-right">åŠ©ç†æ¡ˆæ•¸</th>
                  <th class="text-right">å¸æ©Ÿæ¡ˆæ•¸</th>
                  <th>å¤œç­ / OT</th>
                </tr>
              </thead>
              <tbody id="manpower-tbody">
                <tr>
                  <td colspan="6" class="no-data">è«‹å…ˆé¸æ“‡æœˆä»½ã€‚</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- è¨­å‚™å‡ºå‹¤è¡¨ -->
          <div style="margin-top:10px; font-size:12px; font-weight:600; color:#4b5563;">
            ğŸ› è¨­å‚™å‡ºå‹¤ä¸€è¦½ï¼ˆä¾æ—¥æœŸï¼‰
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th class="text-right">æœ‰è¨­å‚™å°ˆæ¡ˆæ•¸</th>
                  <th class="text-right">è¨­å‚™æˆæœ¬</th>
                  <th>éƒ¨åˆ†å°ˆæ¡ˆåç¨±</th>
                </tr>
              </thead>
              <tbody id="equipment-tbody">
                <tr>
                  <td colspan="4" class="no-data">è«‹å…ˆé¸æ“‡æœˆä»½ã€‚</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- View 3ï¼šè¨­å‚™æ¸…å–® + æª”æœŸè¡Œäº‹æ›† -->
        <div id="view-equipment" style="display:none; margin-top:4px;">
          <div style="font-size:12px; margin-bottom:8px; color:#4b5563;">
            âœ… åœ¨é€™è£¡ç¶­è­·æ‰€æœ‰ç‰¹æ•ˆè¨­å‚™çš„æ¸…å–®èˆ‡åº«å­˜ç¸½æ•¸ï¼Œä¸¦ç”¨è¡Œäº‹æ›†æª¢æŸ¥æª”æœŸæ˜¯å¦è¶…ç”¨ã€‚
          </div>

          <!-- è¨­å‚™è¡¨å–® -->
          <div class="card" style="padding:12px; margin-bottom:12px; box-shadow:none; border:1px solid #e5e7eb;">
            <div style="font-size:13px; font-weight:600; margin-bottom:8px;">
              è¨­å‚™è³‡æ–™ Equipment
              <span class="muted" style="font-size:11px; margin-left:4px;">
                ï¼ˆå…ˆç™»å…¥å³å¯ç·¨è¼¯ï¼‰
              </span>
            </div>
            <form id="equipment-form">
              <div class="form-grid">
                <div>
                  <label>è¨­å‚™åç¨± Name</label>
                  <input type="text" id="eq-name" required placeholder="ä¾‹å¦‚ï¼šç…™éœ§æ©Ÿ 1500W" />
                </div>
                <div>
                  <label>è¨­å‚™ä»£ç¢¼ Code</label>
                  <input type="text" id="eq-code" placeholder="ä¾‹å¦‚ï¼šSMOKE1500" />
                </div>
                <div>
                  <label>åˆ†é¡ Category</label>
                  <input type="text" id="eq-category" placeholder="ä¾‹å¦‚ï¼šç…™éœ§ / ç«ç„° / æ³¡æ³¡â€¦" />
                </div>
                <div>
                  <label>ç¸½æ•¸é‡ Total Quantity</label>
                  <input type="number" id="eq-total" min="0" step="1" />
                </div>
                <div>
                  <label>æ˜¯å¦å•Ÿç”¨ Active</label>
                  <select id="eq-active">
                    <option value="true">ä½¿ç”¨ä¸­</option>
                    <option value="false">åœç”¨ / å ±å»¢</option>
                  </select>
                </div>
                <div class="form-grid-full">
                  <label>å‚™è¨» Notes</label>
                  <textarea id="eq-notes" placeholder="ä¾‹å¦‚ï¼šè‡ªæœ‰ 6 å°ï¼Œå›ºå®šè·ŸæŸé–“å…¬å¸ç§Ÿ 2 å°ã€‚"></textarea>
                </div>
              </div>
              <div class="actions">
                <button type="button" class="btn-secondary btn-small" id="eq-reset-btn">æ¸…é™¤</button>
                <button type="submit" class="btn-primary btn-small" id="eq-submit-btn">å„²å­˜è¨­å‚™</button>
              </div>
              <div id="eq-form-hint" class="muted" style="font-size:11px; margin-top:4px;">
                ğŸ”‘ è«‹å…ˆç™»å…¥ï¼Œç™»å…¥å¾Œå³å¯ç¶­è­·è¨­å‚™æ¸…å–®ã€‚
              </div>
            </form>
          </div>

          <!-- è¨­å‚™åˆ—è¡¨ -->
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>è¨­å‚™åç¨±</th>
                  <th>ä»£ç¢¼</th>
                  <th>åˆ†é¡</th>
                  <th class="text-right">ç¸½æ•¸é‡</th>
                  <th>ç‹€æ…‹</th>
                  <th>å‚™è¨»</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="equipment-master-tbody">
                <tr>
                  <td colspan="7" class="no-data">ç›®å‰é‚„æ²’æœ‰ä»»ä½•è¨­å‚™ï¼Œè«‹ä¸Šæ–¹æ–°å¢ã€‚</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- æª”æœŸè¡Œäº‹æ›† -->
          <div style="margin-top:12px; font-size:12px; font-weight:600; color:#4b5563;">
            ğŸ“† è¨­å‚™æª”æœŸè¡Œäº‹æ›†ï¼ˆæª¢æŸ¥æ˜¯å¦è¶…å‡ºç¸½è¨­å‚™æ•¸ï¼‰
          </div>
          <div class="toolbar-group" style="margin:6px 0 10px;">
            <span style="font-size:12px;">é¸æ“‡è¦æª¢æŸ¥çš„è¨­å‚™ï¼š</span>
            <select id="calendar-equipment-select" style="padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #d1d5db;">
              <option value="">è«‹å…ˆåœ¨ä¸Šæ–¹å»ºç«‹è¨­å‚™æ¸…å–®</option>
            </select>
            <span class="muted" style="font-size:11px;">
              é…åˆåŒä¸€é ä¸Šæ–¹çš„ã€Œæª¢è¦–æœˆä»½ã€ä½¿ç”¨ã€‚
            </span>
          </div>
          <div id="equipment-calendar" class="card" style="padding:8px; box-shadow:none; border:1px dashed #d1d5db; background:#f9fafb;">
            <div class="no-data">è«‹å…ˆé¸æ“‡è¨­å‚™èˆ‡æœˆä»½ã€‚</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ä½ çš„ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDBF3pBxsjJx_VJF4_GHDvY6OQe7U4SCIc",
      authDomain: "yaoyan-fb9cb.firebaseapp.com",
      projectId: "yaoyan-fb9cb",
      storageBucket: "yaoyan-fb9cb.firebasestorage.app",
      messagingSenderId: "288682348042",
      appId: "1:288682348042:web:1fe4657eaf7fa9c5ba59f3",
      measurementId: "G-XYYM91DRLX"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const PROJECTS_COLLECTION = "projects";
    const USERS_COLLECTION = "users";
    const EQUIPMENT_COLLECTION = "equipment";

    let projects = [];
    let editingId = null;
    let selectedId = null;
    let viewMode = "project";
    let unsubscribeProjects = null;
    let unsubscribeEquipment = null;
    let currentUser = null;
    let currentRole = "viewer";

    let equipmentList = [];
    let editingEquipmentId = null;

    function num(v) { return Number(v) || 0; }
    function formatMoney(value) {
      const n = Number(value) || 0;
      return "NT$ " + n.toLocaleString("zh-TW");
    }
    function dateRangeString(start, end) {
      if (!start && !end) return "-";
      if (start && !end) return start;
      if (!start && end) return end;
      return start + " ~ " + end;
    }
    function statusPill(status) {
      switch (status) {
        case "booked": return '<span class="status-pill status-booked">å·²ç¢ºèªæª”æœŸ</span>';
        case "in-progress": return '<span class="status-pill status-progress">åŸ·è¡Œä¸­</span>';
        case "done": return '<span class="status-pill status-done">å·²å®Œæˆ</span>';
        case "cancel": return '<span class="status-pill status-cancel">å–æ¶ˆ</span>';
        default: return "";
      }
    }
    function billingLabel(status) {
      switch (status) {
        case "invoiced": return "å·²é–‹ç«‹ç™¼ç¥¨";
        case "partial": return "éƒ¨åˆ†æ”¶æ¬¾";
        case "paid": return "å·²å…¨é¡æ”¶æ¬¾";
        default: return "å°šæœªé–‹ç«‹";
      }
    }
    function overlapsMonth(project, year, monthIndex) {
      const ms = new Date(year, monthIndex, 1);
      const me = new Date(year, monthIndex + 1, 0, 23, 59, 59);
      const start = project.startDate ? new Date(project.startDate) : new Date("1900-01-01");
      const end = project.endDate ? new Date(project.endDate) : start;
      return end >= ms && start <= me;
    }
    function overlapsDate(project, year, monthIndex, day) {
      const d = new Date(year, monthIndex, day);
      const start = project.startDate ? new Date(project.startDate) : new Date("1900-01-01");
      const end = project.endDate ? new Date(project.endDate) : start;
      return d >= start && d <= end;
    }

    function calcFinancials(p) {
      const quote = num(p.quoteAmount);
      const budget = num(p.budget);
      const revenueBase = budget || quote;
      const taxType = p.taxType || "na";
      const taxRate = 0.05;

      let taxAmount = 0;
      let netRevenue = revenueBase;

      if (revenueBase > 0) {
        if (taxType === "included") {
          taxAmount = (revenueBase * taxRate) / (1 + taxRate);
          netRevenue = revenueBase - taxAmount;
        } else if (taxType === "excluded") {
          taxAmount = revenueBase * taxRate;
          netRevenue = revenueBase;
        }
      }

      const equipmentOwn = num(p.equipmentOwnCost);
      const equipmentRental = num(p.equipmentRentalCost);
      const manTech = num(p.manTech);
      const manAssistant = num(p.manAssistant);
      const manDriver = num(p.manDriver);
      const manNight = num(p.manNight);
      const manOvertime = num(p.manOvertime);
      const manpowerTotal = manTech + manAssistant + manDriver + manNight + manOvertime;
      const otherExpenses = num(p.expenses);

      const totalCost = equipmentOwn + equipmentRental + manpowerTotal + otherExpenses;
      const profit = netRevenue - totalCost;

      return {
        quote,
        budget,
        revenueBase,
        taxAmount,
        netRevenue,
        equipmentOwn,
        equipmentRental,
        manpowerTotal,
        manTech,
        manAssistant,
        manDriver,
        manNight,
        manOvertime,
        otherExpenses,
        totalCost,
        profit,
      };
    }

    function updateFormPermission() {
      const form = document.getElementById("project-form");
      const hint = document.getElementById("form-permission-hint");
      const submitBtn = document.getElementById("submit-btn");
      const resetBtn = document.getElementById("reset-btn");

      const canEdit =
        currentUser &&
        (currentRole === "admin" ||
          currentRole === "manager" ||
          currentRole === "staff");

      const controlIds = [
        "project-name","client","start-date","end-date",
        "equipment-source","equipment-own-cost","equipment-rental-cost",
        "man-tech","man-assistant","man-driver","man-night","man-overtime",
        "quote-amount","budget","expenses","tax-type",
        "invoice-number","invoice-date",
        "expected-payment-date","actual-payment-date",
        "billing-status","project-status","notes"
      ];

      Array.from(form.elements).forEach((el) => {
        if (!el.id) return;
        if (controlIds.includes(el.id)) {
          el.disabled = !canEdit;
        }
      });

      // è¨­å‚™ 10 è¡Œçš„ select / input å¦å¤–è™•ç†
      const eqLineInputs = document.querySelectorAll(
        "#equipment-lines select, #equipment-lines input"
      );
      eqLineInputs.forEach((el) => {
        el.disabled = !canEdit;
      });

      submitBtn.style.display = canEdit ? "inline-flex" : "none";
      resetBtn.style.display = canEdit ? "inline-flex" : "none";
      hint.textContent = canEdit
        ? "âœ… ä½ ç›®å‰å¯ä»¥æ–°å¢ / ç·¨è¼¯å°ˆæ¡ˆã€‚"
        : "ğŸ”’ è«‹å…ˆç™»å…¥ï¼Œä¸”æ¬Šé™ç‚º staff / manager / admin æ‰èƒ½æ–°å¢æˆ–ç·¨è¼¯å°ˆæ¡ˆã€‚";
    }

    function renderEquipmentLines(lines) {
      const container = document.getElementById("equipment-lines");
      if (!container) return;
      container.innerHTML = "";

      for (let i = 0; i < 10; i++) {
        const row = document.createElement("div");
        row.className = "equipment-line-row";

        const labelSpan = document.createElement("span");
        labelSpan.textContent = "è¨­å‚™ " + (i + 1);
        row.appendChild(labelSpan);

        const select = document.createElement("select");
        select.className = "equipment-line-name";
        select.dataset.index = String(i);

        const optEmpty = document.createElement("option");
        optEmpty.value = "";
        optEmpty.textContent = "æœªé¸æ“‡";
        select.appendChild(optEmpty);

        equipmentList.forEach((eq) => {
          const opt = document.createElement("option");
          opt.value = eq.id;
          opt.textContent = eq.name || "(æœªå‘½åè¨­å‚™)";
          select.appendChild(opt);
        });

        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.min = "0";
        qtyInput.step = "1";
        qtyInput.placeholder = "æ•¸é‡";
        qtyInput.className = "equipment-line-qty";
        qtyInput.dataset.index = String(i);

        const lineData = lines && lines[i] ? lines[i] : null;
        if (lineData) {
          if (lineData.equipmentId) {
            select.value = lineData.equipmentId;
          }
          if (lineData.quantity != null) {
            qtyInput.value = String(lineData.quantity);
          }
        }

        row.appendChild(select);
        row.appendChild(qtyInput);
        container.appendChild(row);
      }

      // å¥—ç”¨ disabled ç‹€æ…‹
      updateFormPermission();
    }

    function collectEquipmentLinesFromForm() {
      const result = [];
      const selects = document.querySelectorAll(".equipment-line-name");
      selects.forEach((sel) => {
        const idx = sel.dataset.index;
        const qtyInput = document.querySelector(
          '.equipment-line-qty[data-index="' + idx + '"]'
        );
        if (!qtyInput) return;
        const eqId = sel.value;
        const qty = Number(qtyInput.value || "0");
        if (!eqId || qty <= 0) return;
        const eq = equipmentList.find((e) => e.id === eqId);
        result.push({
          equipmentId: eqId,
          equipmentName: eq ? eq.name || "" : "",
          quantity: qty,
        });
      });
      return result;
    }

    function render() {
      const tbody = document.getElementById("project-tbody");
      const monthInput = document.getElementById("month-filter");
      const projectCountPill = document.getElementById("project-count-pill");

      tbody.innerHTML = "";

      let filtered = projects;
      let year = null;
      let monthIndex = null;

      if (monthInput.value) {
        const [y, m] = monthInput.value.split("-");
        year = Number(y);
        monthIndex = Number(m) - 1;
        filtered = projects.filter((p) => overlapsMonth(p, year, monthIndex));
      }

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.className = "no-data";
        td.textContent = "æ­¤æ¢ä»¶ä¸‹å°šç„¡å°ˆæ¡ˆã€‚";
        tr.appendChild(td);
        tbody.appendChild(tr);
        projectCountPill.textContent = `å…± ${projects.length} ç­†å°ˆæ¡ˆ`;
        updateSummary([]);
        renderDetails(null);
        renderResourceView([], year, monthIndex);
        renderEquipmentCalendar();
        return;
      }

      if (!selectedId || !filtered.some((p) => p.id === selectedId)) {
        selectedId = filtered[0].id;
      }

      filtered.forEach((p) => {
        const tr = document.createElement("tr");
        if (p.id === selectedId) tr.classList.add("row-selected");

        const canEditThis =
          currentUser &&
          (currentRole === "admin" ||
            currentRole === "manager" ||
            (currentRole === "staff" && p.ownerUid === currentUser.uid));

        const fin = calcFinancials(p);

        const tdName = document.createElement("td");
        tdName.innerHTML =
          "<strong>" +
          (p.name || "(æœªå‘½åå°ˆæ¡ˆ)") +
          "</strong><br /><span class='muted'>" +
          (p.client || "æœªå¡«å¯«å®¢æˆ¶") +
          "</span>";

        const tdDates = document.createElement("td");
        tdDates.textContent = dateRangeString(p.startDate, p.endDate);

        const tdNet = document.createElement("td");
        tdNet.className = "text-right";
        tdNet.textContent = formatMoney(fin.netRevenue);

        const tdProfit = document.createElement("td");
        tdProfit.className = "text-right";
        tdProfit.textContent = formatMoney(fin.profit);

        const tdStatus = document.createElement("td");
        tdStatus.innerHTML =
          statusPill(p.projectStatus) +
          "<br /><span class='muted' style='font-size:11px'>" +
          billingLabel(p.billingStatus) +
          "</span>";

        const tdActions = document.createElement("td");
        const selectBtn = document.createElement("button");
        selectBtn.textContent = "æª¢è¦–";
        selectBtn.className = "btn-secondary btn-small";
        selectBtn.onclick = () => {
          selectedId = p.id;
          render();
        };
        tdActions.appendChild(selectBtn);

        if (canEditThis) {
          const editBtn = document.createElement("button");
          editBtn.textContent = "ç·¨è¼¯";
          editBtn.className = "btn-secondary btn-small";
          editBtn.style.marginLeft = "4px";
          editBtn.onclick = () => fillFormForEdit(p.id);

          const delBtn = document.createElement("button");
          delBtn.textContent = "åˆªé™¤";
          delBtn.className = "btn-danger btn-small";
          delBtn.style.marginLeft = "4px";
          delBtn.onclick = () => deleteProject(p.id);

          tdActions.appendChild(editBtn);
          tdActions.appendChild(delBtn);
        }

        tr.appendChild(tdName);
        tr.appendChild(tdDates);
        tr.appendChild(tdNet);
        tr.appendChild(tdProfit);
        tr.appendChild(tdStatus);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });

      projectCountPill.textContent = `å…± ${projects.length} ç­†å°ˆæ¡ˆ`;
      updateSummary(filtered);
      const current = filtered.find((p) => p.id === selectedId) || null;
      renderDetails(current);
      renderResourceView(filtered, year, monthIndex);
      renderEquipmentCalendar();
    }

    function updateSummary(list) {
      const sumQuote = document.getElementById("sum-quote");
      const sumBudget = document.getElementById("sum-budget");
      const sumCost = document.getElementById("sum-cost");
      const sumNetRevenue = document.getElementById("sum-net-revenue");
      const sumProfit = document.getElementById("sum-profit");

      let totalQuote = 0;
      let totalBudget = 0;
      let totalCost = 0;
      let totalNetRevenue = 0;
      let totalProfit = 0;

      list.forEach((p) => {
        const fin = calcFinancials(p);
        totalQuote += fin.quote;
        totalBudget += fin.budget;
        totalCost += fin.totalCost;
        totalNetRevenue += fin.netRevenue;
        totalProfit += fin.profit;
      });

      sumQuote.textContent = formatMoney(totalQuote);
      sumBudget.textContent = formatMoney(totalBudget);
      sumCost.textContent = formatMoney(totalCost);
      sumNetRevenue.textContent = formatMoney(totalNetRevenue);
      sumProfit.textContent = formatMoney(totalProfit);
    }

    function renderDetails(p) {
      const container = document.getElementById("details-card");
      if (!p) {
        container.innerHTML =
          '<div class="no-data">é»é¸ä¸Šæ–¹ä»»ä¸€å°ˆæ¡ˆï¼Œå³å¯æŸ¥çœ‹è©³ç´°æˆæœ¬èˆ‡è«‹æ¬¾è³‡è¨Šã€‚</div>';
        return;
      }

      const fin = calcFinancials(p);
      const equipmentSourceLabel =
        p.equipmentSource === "mixed"
          ? "è‡ªæœ‰ï¼‹ç§Ÿå€Ÿ"
          : p.equipmentSource === "rental"
          ? "ç§Ÿå€Ÿ"
          : "è‡ªæœ‰è¨­å‚™";

      const taxTypeLabel =
        p.taxType === "included"
          ? "å«ç¨… (5% å·²å«åœ¨é‡‘é¡å…§)"
          : p.taxType === "excluded"
          ? "æœªç¨… (5% å¦è¨ˆ)"
          : "ä¸é©ç”¨ / æœªè¨­å®š";

      const invoLabel = p.invoiceNumber
        ? p.invoiceNumber + (p.invoiceDate ? "ï¼ˆ" + p.invoiceDate + "ï¼‰" : "")
        : "æœªå¡«å¯«";

      const equipmentLinesText =
        p.equipmentLines && p.equipmentLines.length
          ? p.equipmentLines
              .map((l) => (l.equipmentName || "æœªå‘½åè¨­å‚™") + " x" + (l.quantity || 0))
              .join(" / ")
          : "â€”";

      container.innerHTML = `
        <div class="details-header">
          <div>
            <div class="details-title">${p.name || "(æœªå‘½åå°ˆæ¡ˆ)"}</div>
            <div class="details-subtitle">
              ${p.client || "æœªå¡«å¯«å®¢æˆ¶"} ï½œ æª”æœŸï¼š${dateRangeString(p.startDate, p.endDate)}
            </div>
          </div>
          <div class="details-subtitle">
            ç‹€æ…‹ï¼š${statusPill(p.projectStatus)}
            <span class="muted">ï¼ ${billingLabel(p.billingStatus)}</span>
          </div>
        </div>

        <div class="details-grid">
          <div>
            <div class="details-section-title">è¨­å‚™</div>
            <div class="details-item-label">ä½¿ç”¨è¨­å‚™</div>
            <div class="details-item-value">${equipmentLinesText}</div>
            <div class="details-item-label">ä¾†æº</div>
            <div class="details-item-value">${equipmentSourceLabel}</div>
            <div class="details-item-label">è‡ªæœ‰æˆæœ¬</div>
            <div class="details-item-value">${formatMoney(fin.equipmentOwn)}</div>
            <div class="details-item-label">ç§Ÿå€Ÿæˆæœ¬</div>
            <div class="details-item-value">${formatMoney(fin.equipmentRental)}</div>
          </div>

          <div>
            <div class="details-section-title">äººåŠ›æˆæœ¬</div>
            <div class="details-item-label">æŠ€å¸«</div>
            <div class="details-item-value">${formatMoney(fin.manTech)}</div>
            <div class="details-item-label">åŠ©ç† / å¸æ©Ÿ</div>
            <div class="details-item-value">
              åŠ©ç†ï¼š${formatMoney(fin.manAssistant)}<br/>
              å¸æ©Ÿï¼š${formatMoney(fin.manDriver)}
            </div>
            <div class="details-item-label">å¤œç­ï¼‹åŠ ç­</div>
            <div class="details-item-value">
              å¤œç­ï¼š${formatMoney(fin.manNight)}<br/>
              åŠ ç­ï¼š${formatMoney(fin.manOvertime)}
            </div>
            <div class="details-item-label">äººåŠ›åˆè¨ˆ</div>
            <div class="details-item-value">${formatMoney(fin.manpowerTotal)}</div>
          </div>

          <div>
            <div class="details-section-title">è²¡å‹™ & æ¯›åˆ©</div>
            <div class="details-item-label">å ±åƒ¹ Quote</div>
            <div class="details-item-value">${formatMoney(fin.quote)}</div>
            <div class="details-item-label">åŸ·è¡Œé ç®— Budget</div>
            <div class="details-item-value">${formatMoney(fin.budget)}</div>
            <div class="details-item-label">ç¨…åˆ¥ / é ä¼°ç¨…é¡</div>
            <div class="details-item-value">
              ${taxTypeLabel}<br/>
              ç¨…é¡ï¼šç´„ ${formatMoney(fin.taxAmount)}
            </div>
            <div class="details-item-label">æ·¨ç‡Ÿæ”¶ / ç¸½æˆæœ¬</div>
            <div class="details-item-value">
              æ·¨ç‡Ÿæ”¶ï¼š${formatMoney(fin.netRevenue)}<br/>
              æˆæœ¬åˆè¨ˆï¼š${formatMoney(fin.totalCost)}
            </div>
            <div class="details-item-label">é ä¼°æ¯›åˆ©</div>
            <div class="details-item-value">${formatMoney(fin.profit)}</div>
          </div>

          <div>
            <div class="details-section-title">å…¶ä»–æ”¯å‡º</div>
            <div class="details-item-label">å…¶ä»–æ”¯å‡º Other Expenses</div>
            <div class="details-item-value">${formatMoney(fin.otherExpenses)}</div>
            <div class="details-item-label">è¨­å‚™ï¼‹äººåŠ›ï¼‹å…¶ä»–</div>
            <div class="details-item-value">
              è¨­å‚™ï¼š${formatMoney(fin.equipmentOwn + fin.equipmentRental)}<br/>
              äººåŠ›ï¼š${formatMoney(fin.manpowerTotal)}<br/>
              å…¶ä»–ï¼š${formatMoney(fin.otherExpenses)}
            </div>
          </div>

          <div>
            <div class="details-section-title">è«‹æ¬¾è³‡è¨Š</div>
            <div class="details-item-label">ç™¼ç¥¨</div>
            <div class="details-item-value">${invoLabel}</div>
            <div class="details-item-label">é è¨ˆæ”¶æ¬¾æ—¥</div>
            <div class="details-item-value">${p.expectedPaymentDate || "æœªå¡«å¯«"}</div>
            <div class="details-item-label">å¯¦éš›æ”¶æ¬¾æ—¥</div>
            <div class="details-item-value">${p.actualPaymentDate || "æœªå¡«å¯«"}</div>
          </div>

          <div class="form-grid-full">
            <div class="details-section-title">å‚™è¨» Notes</div>
            <div class="details-item-value">${p.notes ? p.notes.replace(/\n/g,"<br/>") : "â€”"}</div>
          </div>
        </div>
      `;
    }

    function renderResourceView(list, year, monthIndex) {
      const sumManTechEl = document.getElementById("sum-man-tech");
      const sumManAssistantEl = document.getElementById("sum-man-assistant");
      const sumManDriverEl = document.getElementById("sum-man-driver");
      const sumManExtraEl = document.getElementById("sum-man-extra");
      const sumEquipmentEl = document.getElementById("sum-equipment");
      const manpowerTbody = document.getElementById("manpower-tbody");
      const equipmentTbody = document.getElementById("equipment-tbody");

      let totalManTech = 0;
      let totalManAssistant = 0;
      let totalManDriver = 0;
      let totalManExtra = 0;
      let totalEquipment = 0;

      list.forEach((p) => {
        const fin = calcFinancials(p);
        totalManTech += fin.manTech;
        totalManAssistant += fin.manAssistant;
        totalManDriver += fin.manDriver;
        totalManExtra += fin.manNight + fin.manOvertime;
        totalEquipment += fin.equipmentOwn + fin.equipmentRental;
      });

      sumManTechEl.textContent = formatMoney(totalManTech);
      sumManAssistantEl.textContent = formatMoney(totalManAssistant);
      sumManDriverEl.textContent = formatMoney(totalManDriver);
      sumManExtraEl.textContent = formatMoney(totalManExtra);
      sumEquipmentEl.textContent = formatMoney(totalEquipment);

      if (!year && !monthIndex && list.length === 0) {
        manpowerTbody.innerHTML =
          '<tr><td colspan="6" class="no-data">è«‹å…ˆé¸æ“‡æœˆä»½ã€‚</td></tr>';
        equipmentTbody.innerHTML =
          '<tr><td colspan="4" class="no-data">è«‹å…ˆé¸æ“‡æœˆä»½ã€‚</td></tr>';
        return;
      }

      if (!list || list.length === 0) {
        manpowerTbody.innerHTML =
          '<tr><td colspan="6" class="no-data">æ­¤æœˆä»½æ²’æœ‰ä»»ä½•å°ˆæ¡ˆã€‚</td></tr>';
        equipmentTbody.innerHTML =
          '<tr><td colspan="4" class="no-data">æ­¤æœˆä»½æ²’æœ‰ä»»ä½•å°ˆæ¡ˆã€‚</td></tr>';
        return;
      }

      const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();

      manpowerTbody.innerHTML = "";
      for (let d = 1; d <= daysInMonth; d++) {
        let activeCount = 0;
        let techCount = 0;
        let assistantCount = 0;
        let driverCount = 0;
        let hasNight = false;
        let hasOT = false;

        list.forEach((p) => {
          if (!overlapsDate(p, year, monthIndex, d)) return;
          const fin = calcFinancials(p);
          const hasAnyCost =
            fin.manTech || fin.manAssistant || fin.manDriver ||
            fin.manNight || fin.manOvertime ||
            fin.equipmentOwn || fin.equipmentRental || fin.otherExpenses;
          if (!hasAnyCost) return;

          activeCount++;
          if (fin.manTech > 0) techCount++;
          if (fin.manAssistant > 0) assistantCount++;
          if (fin.manDriver > 0) driverCount++;
          if (fin.manNight > 0) hasNight = true;
          if (fin.manOvertime > 0) hasOT = true;
        });

        const tr = document.createElement("tr");
        const dateStr =
          String(monthIndex + 1).padStart(2, "0") +
          "/" +
          String(d).padStart(2, "0");

        const tdDate = document.createElement("td");
        tdDate.textContent = dateStr;

        const tdActive = document.createElement("td");
        tdActive.className = "text-right";
        tdActive.textContent = activeCount || "-";

        const tdTech = document.createElement("td");
        tdTech.className = "text-right";
        tdTech.textContent = techCount || "-";

        const tdAssistant = document.createElement("td");
        tdAssistant.className = "text-right";
        tdAssistant.textContent = assistantCount || "-";

        const tdDriver = document.createElement("td");
        tdDriver.className = "text-right";
        tdDriver.textContent = driverCount || "-";

        const tdExtra = document.createElement("td");
        tdExtra.textContent =
          activeCount === 0
            ? "-"
            : (hasNight ? "å¤œç­" : "") +
              (hasNight && hasOT ? " / " : "") +
              (hasOT ? "åŠ ç­" : "") || "â€”";

        tr.appendChild(tdDate);
        tr.appendChild(tdActive);
        tr.appendChild(tdTech);
        tr.appendChild(tdAssistant);
        tr.appendChild(tdDriver);
        tr.appendChild(tdExtra);

        manpowerTbody.appendChild(tr);
      }

      equipmentTbody.innerHTML = "";
      for (let d = 1; d <= daysInMonth; d++) {
        let equipCount = 0;
        let equipCost = 0;
        const projectNames = [];

        list.forEach((p) => {
          if (!overlapsDate(p, year, monthIndex, d)) return;
          const fin = calcFinancials(p);
          const hasEquip =
            (p.equipmentLines && p.equipmentLines.length > 0) ||
            fin.equipmentOwn > 0 ||
            fin.equipmentRental > 0;
          if (!hasEquip) return;

          equipCount++;
          equipCost += fin.equipmentOwn + fin.equipmentRental;
          if (projectNames.length < 3) {
            projectNames.push(p.name || "(æœªå‘½åå°ˆæ¡ˆ)");
          }
        });

        const tr = document.createElement("tr");
        const dateStr =
          String(monthIndex + 1).padStart(2, "0") +
          "/" +
          String(d).padStart(2, "0");

        const tdDate = document.createElement("td");
        tdDate.textContent = dateStr;

        const tdCount = document.createElement("td");
        tdCount.className = "text-right";
        tdCount.textContent = equipCount || "-";

        const tdCost = document.createElement("td");
        tdCost.className = "text-right";
        tdCost.textContent =
          equipCount === 0 ? "-" : formatMoney(equipCost);

        const tdNames = document.createElement("td");
        tdNames.textContent =
          equipCount === 0
            ? "-"
            : projectNames.join(" / ") +
              (equipCount > projectNames.length ? " ..." : "");

        tr.appendChild(tdDate);
        tr.appendChild(tdCount);
        tr.appendChild(tdCost);
        tr.appendChild(tdNames);

        equipmentTbody.appendChild(tr);
      }
    }

    function resetForm() {
      const form = document.getElementById("project-form");
      form.reset();
      editingId = null;
      document.getElementById("form-title").textContent = "æ–°å¢å°ˆæ¡ˆ Project";
      document.getElementById("submit-btn").textContent = "æ–°å¢å°ˆæ¡ˆ Add";
      renderEquipmentLines([]);
    }

    function fillFormForEdit(id) {
      const p = projects.find((x) => x.id === id);
      if (!p) return;

      const canEditThis =
        currentUser &&
        (currentRole === "admin" ||
          currentRole === "manager" ||
          (currentRole === "staff" && p.ownerUid === currentUser.uid));
      if (!canEditThis) {
        alert("ä½ æ²’æœ‰æ¬Šé™ç·¨è¼¯é€™ç­†å°ˆæ¡ˆã€‚");
        return;
      }

      editingId = id;
      document.getElementById("form-title").textContent = "ç·¨è¼¯å°ˆæ¡ˆ Edit Project";
      document.getElementById("submit-btn").textContent = "æ›´æ–°å°ˆæ¡ˆ Update";

      document.getElementById("project-name").value = p.name || "";
      document.getElementById("client").value = p.client || "";
      document.getElementById("start-date").value = p.startDate || "";
      document.getElementById("end-date").value = p.endDate || "";
      document.getElementById("equipment-source").value = p.equipmentSource || "own";
      document.getElementById("equipment-own-cost").value = p.equipmentOwnCost || "";
      document.getElementById("equipment-rental-cost").value = p.equipmentRentalCost || "";
      document.getElementById("man-tech").value = p.manTech || "";
      document.getElementById("man-assistant").value = p.manAssistant || "";
      document.getElementById("man-driver").value = p.manDriver || "";
      document.getElementById("man-night").value = p.manNight || "";
      document.getElementById("man-overtime").value = p.manOvertime || "";
      document.getElementById("quote-amount").value = p.quoteAmount || "";
      document.getElementById("budget").value = p.budget || "";
      document.getElementById("expenses").value = p.expenses || "";
      document.getElementById("tax-type").value = p.taxType || "na";
      document.getElementById("invoice-number").value = p.invoiceNumber || "";
      document.getElementById("invoice-date").value = p.invoiceDate || "";
      document.getElementById("expected-payment-date").value = p.expectedPaymentDate || "";
      document.getElementById("actual-payment-date").value = p.actualPaymentDate || "";
      document.getElementById("billing-status").value = p.billingStatus || "none";
      document.getElementById("project-status").value = p.projectStatus || "booked";
      document.getElementById("notes").value = p.notes || "";

      renderEquipmentLines(p.equipmentLines || []);
    }

    async function deleteProject(id) {
      const p = projects.find((x) => x.id === id);
      if (!p) return;

      const canEditThis =
        currentUser &&
        (currentRole === "admin" ||
          currentRole === "manager" ||
          (currentRole === "staff" && p.ownerUid === currentUser.uid));
      if (!canEditThis) {
        alert("ä½ æ²’æœ‰æ¬Šé™åˆªé™¤é€™ç­†å°ˆæ¡ˆã€‚");
        return;
      }

      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†å°ˆæ¡ˆå—ï¼Ÿ")) return;
      await db.collection(PROJECTS_COLLECTION).doc(id).delete();
    }

    function switchView(mode) {
      viewMode = mode;
      const viewProject = document.getElementById("view-project");
      const viewResource = document.getElementById("view-resource");
      const viewEquipment = document.getElementById("view-equipment");
      const tabProject = document.getElementById("tab-project");
      const tabResource = document.getElementById("tab-resource");
      const tabEquipment = document.getElementById("tab-equipment");

      if (mode === "project") {
        viewProject.style.display = "";
        viewResource.style.display = "none";
        viewEquipment.style.display = "none";
        tabProject.classList.add("tab-button-active");
        tabResource.classList.remove("tab-button-active");
        tabEquipment.classList.remove("tab-button-active");
      } else if (mode === "resource") {
        viewProject.style.display = "none";
        viewResource.style.display = "";
        viewEquipment.style.display = "none";
        tabProject.classList.remove("tab-button-active");
        tabResource.classList.add("tab-button-active");
        tabEquipment.classList.remove("tab-button-active");
      } else if (mode === "equipment") {
        viewProject.style.display = "none";
        viewResource.style.display = "none";
        viewEquipment.style.display = "";
        tabProject.classList.remove("tab-button-active");
        tabResource.classList.remove("tab-button-active");
        tabEquipment.classList.add("tab-button-active");
      }
    }

    async function ensureUserDoc(user) {
      const userRef = db.collection(USERS_COLLECTION).doc(user.uid);
      const snap = await userRef.get();
      if (!snap.exists) {
        await userRef.set({
          email: user.email || "",
          displayName: user.displayName || "",
          role: "viewer",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
        return "viewer";
      } else {
        const data = snap.data();
        return data.role || "viewer";
      }
    }

    function subscribeProjects() {
      if (unsubscribeProjects) unsubscribeProjects();
      unsubscribeProjects = db
        .collection(PROJECTS_COLLECTION)
        .orderBy("startDate")
        .onSnapshot((snapshot) => {
          projects = [];
          snapshot.forEach((doc) => {
            projects.push({ id: doc.id, ...doc.data() });
          });
          render();
        });
    }

    function renderEquipmentListTable() {
      const tbody = document.getElementById("equipment-master-tbody");
      const formHint = document.getElementById("eq-form-hint");
      if (!tbody || !formHint) return;

      tbody.innerHTML = "";

      if (!equipmentList.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.className = "no-data";
        td.textContent = "ç›®å‰é‚„æ²’æœ‰ä»»ä½•è¨­å‚™ï¼Œè«‹ä¸Šæ–¹æ–°å¢ã€‚";
        tr.appendChild(td);
        tbody.appendChild(tr);
      } else {
        equipmentList.forEach((eq) => {
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.textContent = eq.name || "(æœªå‘½åè¨­å‚™)";

          const tdCode = document.createElement("td");
          tdCode.textContent = eq.code || "â€”";

          const tdCategory = document.createElement("td");
          tdCategory.textContent = eq.category || "â€”";

          const tdTotal = document.createElement("td");
          tdTotal.className = "text-right";
          tdTotal.textContent = eq.totalQuantity != null ? eq.totalQuantity : "â€”";

          const tdStatus = document.createElement("td");
          tdStatus.textContent = eq.isActive === false ? "åœç”¨" : "ä½¿ç”¨ä¸­";

          const tdNotes = document.createElement("td");
          tdNotes.textContent = eq.notes || "â€”";

          const tdActions = document.createElement("td");

          const editBtn = document.createElement("button");
          editBtn.textContent = "ç·¨è¼¯";
          editBtn.className = "btn-secondary btn-small";
          editBtn.onclick = () => fillEquipmentForm(eq.id);

          const delBtn = document.createElement("button");
          delBtn.textContent = "åˆªé™¤";
          delBtn.className = "btn-danger btn-small";
          delBtn.style.marginLeft = "4px";
          delBtn.onclick = () => deleteEquipment(eq.id);

          tdActions.appendChild(editBtn);
          tdActions.appendChild(delBtn);

          tr.appendChild(tdName);
          tr.appendChild(tdCode);
          tr.appendChild(tdCategory);
          tr.appendChild(tdTotal);
          tr.appendChild(tdStatus);
          tr.appendChild(tdNotes);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });
      }

      if (!currentUser) {
        formHint.textContent = "ğŸ”‘ è«‹å…ˆç™»å…¥ï¼Œç™»å…¥å¾Œå³å¯ç¶­è­·è¨­å‚™æ¸…å–®ã€‚";
      } else {
        formHint.textContent = "âœ… ä½ å·²ç™»å…¥ï¼Œå¯ä»¥æ–°å¢ / ç·¨è¼¯ / åˆªé™¤è¨­å‚™ã€‚";
      }
    }

    function renderEquipmentSelectForCalendar() {
      const select = document.getElementById("calendar-equipment-select");
      if (!select) return;
      const prev = select.value;
      select.innerHTML = "";

      if (!equipmentList.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "è«‹å…ˆåœ¨ä¸Šæ–¹å»ºç«‹è¨­å‚™æ¸…å–®";
        select.appendChild(opt);
        return;
      }

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "è«‹é¸æ“‡è¨­å‚™";
      select.appendChild(opt0);

      equipmentList.forEach((eq) => {
        const opt = document.createElement("option");
        opt.value = eq.id;
        opt.textContent =
          (eq.name || "(æœªå‘½åè¨­å‚™)") +
          (eq.totalQuantity != null ? "ï¼ˆç¸½æ•¸ " + eq.totalQuantity + "ï¼‰" : "");
        select.appendChild(opt);
      });

      if (prev && equipmentList.some((e) => e.id === prev)) {
        select.value = prev;
      }
    }

    function subscribeEquipment() {
      if (unsubscribeEquipment) unsubscribeEquipment();
      unsubscribeEquipment = db
        .collection(EQUIPMENT_COLLECTION)
        .orderBy("name")
        .onSnapshot((snapshot) => {
          equipmentList = [];
          snapshot.forEach((doc) => {
            equipmentList.push({ id: doc.id, ...doc.data() });
          });
          renderEquipmentListTable();
          renderEquipmentSelectForCalendar();

          if (editingId) {
            const p = projects.find((x) => x.id === editingId);
            renderEquipmentLines(p && p.equipmentLines ? p.equipmentLines : []);
          } else {
            renderEquipmentLines([]);
          }
          renderEquipmentCalendar();
        });
    }

    function resetEquipmentForm() {
      const form = document.getElementById("equipment-form");
      if (!form) return;
      form.reset();
      editingEquipmentId = null;
    }

    function fillEquipmentForm(id) {
      const eq = equipmentList.find((x) => x.id === id);
      if (!eq) return;

      editingEquipmentId = id;
      document.getElementById("eq-name").value = eq.name || "";
      document.getElementById("eq-code").value = eq.code || "";
      document.getElementById("eq-category").value = eq.category || "";
      document.getElementById("eq-total").value =
        eq.totalQuantity != null ? eq.totalQuantity : "";
      document.getElementById("eq-active").value =
        eq.isActive === false ? "false" : "true";
      document.getElementById("eq-notes").value = eq.notes || "";
    }

    async function deleteEquipment(id) {
      if (!currentUser) {
        alert("è«‹å…ˆç™»å…¥å†åˆªé™¤è¨­å‚™ã€‚");
        return;
      }
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¨­å‚™ï¼Ÿ")) return;
      await db.collection(EQUIPMENT_COLLECTION).doc(id).delete();
    }

    function renderEquipmentCalendar() {
      const container = document.getElementById("equipment-calendar");
      const monthInput = document.getElementById("month-filter");
      const select = document.getElementById("calendar-equipment-select");
      if (!container || !monthInput || !select) return;

      if (!monthInput.value || !select.value) {
        container.innerHTML =
          '<div class="no-data">è«‹å…ˆé¸æ“‡è¨­å‚™èˆ‡æœˆä»½ã€‚</div>';
        return;
      }

      const eqId = select.value;
      const eq = equipmentList.find((e) => e.id === eqId);
      if (!eq) {
        container.innerHTML =
          '<div class="no-data">æ‰¾ä¸åˆ°é€™å€‹è¨­å‚™ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚</div>';
        return;
      }

      const totalQty = Number(eq.totalQuantity || 0);
      if (totalQty <= 0) {
        container.innerHTML =
          '<div class="no-data">æ­¤è¨­å‚™å°šæœªè¨­å®šã€Œç¸½æ•¸é‡ã€ï¼Œç„¡æ³•æª¢æŸ¥æ˜¯å¦è¶…ç”¨ã€‚è«‹åœ¨ä¸Šæ–¹è¨­å‚™æ¸…å–®è¨­å®šç¸½æ•¸ã€‚</div>';
        return;
      }

      const [yStr, mStr] = monthInput.value.split("-");
      const year = Number(yStr);
      const monthIndex = Number(mStr) - 1;
      const firstDay = new Date(year, monthIndex, 1).getDay();
      const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();

      let html = "";
      html += `<div style="font-size:12px; margin-bottom:4px;">
        æª¢æŸ¥è¨­å‚™ï¼š<strong>${eq.name || "(æœªå‘½åè¨­å‚™)"}</strong>ï¼ˆç¸½æ•¸ ${totalQty} å°ï¼‰
      </div>`;
      html += `<div style="font-size:11px; margin-bottom:4px;">
        <span style="background:#ecfdf5; padding:2px 6px; border-radius:999px; margin-right:4px;">æ­£å¸¸</span>
        <span style="background:#fee2e2; padding:2px 6px; border-radius:999px;">è¶…ç”¨</span>
      </div>`;
      html += `<table class="calendar-table">
        <thead>
          <tr>
            <th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th>
          </tr>
        </thead>
        <tbody>
      `;

      let day = 1;
      for (let week = 0; week < 6 && day <= daysInMonth; week++) {
        html += "<tr>";
        for (let wd = 0; wd < 7; wd++) {
          if (week === 0 && wd < firstDay || day > daysInMonth) {
            html += "<td></td>";
          } else {
            let usedQty = 0;
            projects.forEach((p) => {
              if (!overlapsDate(p, year, monthIndex, day)) return;
              if (!p.equipmentLines || !p.equipmentLines.length) return;
              p.equipmentLines.forEach((line) => {
                if (line.equipmentId === eqId) {
                  usedQty += Number(line.quantity || 0);
                }
              });
            });
            const isOver = usedQty > totalQty;
            const cellClass = isOver ? "calendar-over" : "calendar-ok";
            html += `<td class="${cellClass}">
              <div class="calendar-day-number">${day}</div>
              <div class="calendar-day-usage">
                ä½¿ç”¨ï¼š${usedQty} å°<br/>ç¸½æ•¸ï¼š${totalQty}
              </div>
            </td>`;
            day++;
          }
        }
        html += "</tr>";
      }

      html += "</tbody></table>";
      container.innerHTML = html;
    }

    window.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("project-form");
      const monthFilter = document.getElementById("month-filter");
      const resetBtn = document.getElementById("reset-btn");
      const tabProject = document.getElementById("tab-project");
      const tabResource = document.getElementById("tab-resource");
      const tabEquipment = document.getElementById("tab-equipment");
      const loginBtn = document.getElementById("login-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const userInfoText = document.getElementById("user-info-text");
      const userRolePill = document.getElementById("user-role-pill");
      const eqForm = document.getElementById("equipment-form");
      const eqResetBtn = document.getElementById("eq-reset-btn");
      const calEqSelect = document.getElementById("calendar-equipment-select");

      const today = new Date();
      const monthString =
        today.getFullYear() + "-" + String(today.getMonth() + 1).padStart(2, "0");
      monthFilter.value = monthString;

      renderEquipmentLines([]);
      renderEquipmentListTable();
      renderEquipmentSelectForCalendar();
      renderEquipmentCalendar();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const canEdit =
          currentUser &&
          (currentRole === "admin" ||
            currentRole === "manager" ||
            currentRole === "staff");
        if (!canEdit) {
          alert("ä½ ç›®å‰æ²’æœ‰æ¬Šé™æ–°å¢æˆ–ç·¨è¼¯å°ˆæ¡ˆã€‚");
          return;
        }

        const name = document.getElementById("project-name").value.trim();
        const client = document.getElementById("client").value.trim();
        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;
        const equipmentSource =
          document.getElementById("equipment-source").value || "own";
        const equipmentOwnCost =
          document.getElementById("equipment-own-cost").value || "0";
        const equipmentRentalCost =
          document.getElementById("equipment-rental-cost").value || "0";
        const manTech = document.getElementById("man-tech").value || "0";
        const manAssistant =
          document.getElementById("man-assistant").value || "0";
        const manDriver = document.getElementById("man-driver").value || "0";
        const manNight = document.getElementById("man-night").value || "0";
        const manOvertime = document.getElementById("man-overtime").value || "0";
        const quoteAmount =
          document.getElementById("quote-amount").value || "0";
        const budget = document.getElementById("budget").value || "0";
        const expenses = document.getElementById("expenses").value || "0";
        const taxType = document.getElementById("tax-type").value || "na";
        const invoiceNumber =
          document.getElementById("invoice-number").value.trim();
        const invoiceDate =
          document.getElementById("invoice-date").value || "";
        const expectedPaymentDate =
          document.getElementById("expected-payment-date").value || "";
        const actualPaymentDate =
          document.getElementById("actual-payment-date").value || "";
        const billingStatus =
          document.getElementById("billing-status").value || "none";
        const projectStatus =
          document.getElementById("project-status").value || "booked";
        const notes = document.getElementById("notes").value.trim();

        if (!name || !startDate) {
          alert("è‡³å°‘è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±èˆ‡æª”æœŸé–‹å§‹æ—¥æœŸã€‚");
          return;
        }

        const equipmentLines = collectEquipmentLinesFromForm();
        const equipmentSummary =
          equipmentLines.length > 0
            ? equipmentLines
                .map((l) => (l.equipmentName || "è¨­å‚™") + " x" + l.quantity)
                .join(" / ")
            : "";

        const payload = {
          name,
          client,
          startDate,
          endDate,
          equipmentSource,
          equipmentOwnCost,
          equipmentRentalCost,
          manTech,
          manAssistant,
          manDriver,
          manNight,
          manOvertime,
          quoteAmount,
          budget,
          expenses,
          taxType,
          invoiceNumber,
          invoiceDate,
          expectedPaymentDate,
          actualPaymentDate,
          billingStatus,
          projectStatus,
          notes,
          equipmentLines,
          equipmentSummary,
          ownerUid: currentUser ? currentUser.uid : null,
          ownerEmail: currentUser ? currentUser.email : "",
          ownerName: currentUser ? (currentUser.displayName || "") : "",
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        };

        if (!editingId) {
          payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const docRef = await db.collection(PROJECTS_COLLECTION).add(payload);
          selectedId = docRef.id;
        } else {
          await db.collection(PROJECTS_COLLECTION).doc(editingId).update(payload);
          selectedId = editingId;
        }

        resetForm();
      });

      resetBtn.addEventListener("click", (e) => {
        e.preventDefault();
        resetForm();
      });

      monthFilter.addEventListener("change", () => {
        render();
        renderEquipmentCalendar();
      });

      if (calEqSelect) {
        calEqSelect.addEventListener("change", () => {
          renderEquipmentCalendar();
        });
      }

      tabProject.addEventListener("click", () => switchView("project"));
      tabResource.addEventListener("click", () => switchView("resource"));
      tabEquipment.addEventListener("click", () => switchView("equipment"));

      if (eqForm) {
        eqForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!currentUser) {
            alert("è«‹å…ˆç™»å…¥å†å„²å­˜è¨­å‚™ã€‚");
            return;
          }

          const name = document.getElementById("eq-name").value.trim();
          if (!name) {
            alert("è«‹è¼¸å…¥è¨­å‚™åç¨±ã€‚");
            return;
          }

          const payload = {
            name,
            code: document.getElementById("eq-code").value.trim(),
            category: document.getElementById("eq-category").value.trim(),
            totalQuantity: Number(document.getElementById("eq-total").value || "0"),
            isActive: document.getElementById("eq-active").value === "false" ? false : true,
            notes: document.getElementById("eq-notes").value.trim(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          };

          try {
            if (!editingEquipmentId) {
              payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
              await db.collection(EQUIPMENT_COLLECTION).add(payload);
            } else {
              await db.collection(EQUIPMENT_COLLECTION).doc(editingEquipmentId).update(payload);
            }
            resetEquipmentForm();
          } catch (err) {
            console.error(err);
            alert("å„²å­˜è¨­å‚™å¤±æ•—ï¼š" + err.message);
          }
        });

        eqResetBtn.addEventListener("click", (e) => {
          e.preventDefault();
          resetEquipmentForm();
        });
      }

      loginBtn.addEventListener("click", async () => {
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithPopup(provider);
        } catch (err) {
          console.error(err);
          alert("ç™»å…¥å¤±æ•—ï¼š" + err.message);
        }
      });

      logoutBtn.addEventListener("click", async () => {
        await auth.signOut();
      });

      auth.onAuthStateChanged(async (user) => {
        currentUser = user || null;

        if (!user) {
          currentRole = "viewer";
          userInfoText.textContent = "å°šæœªç™»å…¥";
          userRolePill.style.display = "none";
          loginBtn.style.display = "inline-flex";
          logoutBtn.style.display = "none";

          projects = [];
          equipmentList = [];
          render();
          renderEquipmentListTable();
          renderEquipmentSelectForCalendar();
          renderEquipmentLines([]);
          renderEquipmentCalendar();
          updateFormPermission();

          if (unsubscribeProjects) {
            unsubscribeProjects();
            unsubscribeProjects = null;
          }
          if (unsubscribeEquipment) {
            unsubscribeEquipment();
            unsubscribeEquipment = null;
          }
          return;
        }

        userInfoText.textContent =
          user.displayName || user.email || "å·²ç™»å…¥ä½¿ç”¨è€…";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-flex";

        const role = await ensureUserDoc(user);
        currentRole = role || "viewer";
        userRolePill.textContent = role.toUpperCase();
        userRolePill.style.display = "inline-block";

        updateFormPermission();
        subscribeProjects();
        subscribeEquipment();
      });

      render();
      renderEquipmentListTable();
      renderEquipmentSelectForCalendar();
      renderEquipmentCalendar();
      updateFormPermission();
    });
  </script>
</body>
</html>
